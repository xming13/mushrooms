var XMing=XMing||{};XMing.GameStateManager=new function(){var i,a,e,t=0,s={},n={INITIAL:"initial",START:"start",PAUSE:"pause",END:"end"},o={SINGLE:"single",DOUBLE:"double",POISON:"poison"};this.init=function(){window.addEventListener("resize",this.onResize.bind(this),!1),this.initGame()},this.loadData=function(){var i=this,n="<li><div class='shroom-holder'><div class='image-holder'><img class='new-shroom' src='images/transparent.png' /></div></div></li>",c=[];_.times(16,function(){c.push(n)}),$(".game-grid").html(""),_.each(c,function(i){$(".game-grid").append(i)}),this.onResize(),$("html, body").scrollTop($("#panel-container").offset().top),e=60,function r(){var a=_.random(1,4);_.each(_.sample($(".image-holder"),a),function(i){if(!$(i).data("type")){var a=_.sample(o);$(i).data("type",a),$(i).find("img").attr("src",s[a])}}),_.each($(".image-holder"),function(i){var a=$(i);if(a.data("type")&&!a.data("hasStarted")&&!a.data("hasStopped")){var e=a.parent().parent("li").height();a.css("top",e+"px").data("hasStarted",!0).animate({top:"0px"},{duration:500,complete:function(){var i=$(this);setTimeout(function(){i.data("hasStopped")||i.animate({top:e+"px"},{duration:500,complete:function(){i.css("top",e+"px").data("type","").data("isClicked","").data("hasStarted","")}})},1e3)}})}}),i.isGameStateEnd()||setTimeout(r,2e3)}(),$(".image-holder").click(function(){var i=$(this);if(i.data("type")&&!i.data("hasStopped")){var a,e=i.data("type"),n=i.find("img"),c=!1;switch(e){case o.SINGLE:n.attr("src",s[e+"-clicked"]),t++,a=$("<div class='score-popup animated bounceIn'>+1</div>");break;case o.DOUBLE:i.data("isClicked")?(n.attr("src",s[e+"-clicked-twice"]),t+=2,a=$("<div class='score-popup animated bounceIn'>+2</div>")):(i.data("isClicked",!0),n.attr("src",s[e+"-clicked-once"]),c=!0);break;case o.POISON:n.attr("src",s[e+"-clicked"]),t--,a=$("<div class='score-popup penalty animated bounceIn'>-1</div>")}if(!c){$("#score-value").html(t),i.data("hasStopped",!0).stop();var r=i.parent().parent("li"),m=$("<img src='images/mushroom-small.png' class='popup' />");a.prepend(m),r.prepend(a),a.css("top",this.offsetTop-m.height()+"px"),$(".score-popup").one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){a.remove()}),setTimeout(function(){a.remove(),i.css("top",r.height()+"px").data("type","").data("isClicked","").data("hasStarted","").data("hasStopped","")},500)}}}),function m(){e-=1,$("#timer-value").html(Math.ceil(e)),0>=e?(clearTimeout(a),i.endGame()):a=setTimeout(m,1e3)}()},this.onResize=function(){var i=$(".game-grid").children("li"),a=_.max(i,function(i){return $(i).width()}),e=$(a).width();_.each(i,function(i){$(i).height(e),$(i).find(".content:not(.last)").css("line-height",e+"px")})},this.preloadImage=function(){var i=new Image;i.src="images/mushroom.png",s[o.SINGLE]=i.src;var a=new Image;a.src="images/mushroom-clicked.png",s[o.SINGLE+"-clicked"]=a.src;var e=new Image;e.src="images/mushroom-double.png",s[o.DOUBLE]=e.src;var t=new Image;t.src="images/mushroom-double-clicked-once.png",s[o.DOUBLE+"-clicked-once"]=t.src;var n=new Image;n.src="images/mushroom-double-clicked-twice.png",s[o.DOUBLE+"-clicked-twice"]=n.src;var c=new Image;c.src="images/mushroom-poison.png",s[o.POISON]=c.src;var r=new Image;r.src="images/mushroom-poison-clicked.png",s[o.POISON+"-clicked"]=r.src;var m=new Image;m.src="images/pig.png";var d=new Image;d.src="images/pig-mushroom-cap.png";var l=new Image;l.src="images/wildboar.png";var p=new Image;p.src="images/wildboar-mushroom-cap.png"},this.initGame=function(){i=n.INITIAL,this.preloadImage()},this.startGame=function(){i=n.START,t=0,$("#timer").show(),$("#replay").hide(),this.loadData()},this.endGame=function(){i=n.END;var a="<li><div class='content end-mushroom'><img src='images/mushroom.png' class='animated tada' /></div></li>";a+="<li><div class='content'><img src='images/mushroom-clicked.png' /></div></li>",a+="<li><div class='content end-mushroom-poison'><img src='images/mushroom-poison.png' class='animated tada' /></div></li>",a+="<li><div class='content'><img src='images/mushroom-poison-clicked.png' /></div></li>",a+="<li><div class='content'>G</div></li>",a+="<li><div class='content'>A</div></li>",a+="<li><div class='content'>M</div></li>",a+="<li><div class='content'>E</div></li>",a+="<li><div class='content'>O</div></li>",a+="<li><div class='content'>V</div></li>",a+="<li><div class='content'>E</div></li>",a+="<li><div class='content'>R</div></li>",a+="<li><div class='content'><img src='images/mushroom-double.png' /></div></li>",a+="<li><div class='content'><img src='images/mushroom-double-clicked-once.png' /></div></li>",a+="<li><div class='content'><img src='images/mushroom-double-clicked-twice.png' /></div></li>",a+="<li><div class='content last'><img src='images/mushroom-small.png' class='small animated' /></div></li>",$(".game-grid").html(a),$("#timer").hide(),$("#replay").show(),$("#score-value").html(t),this.onResize(),$("html, body").scrollTop($("#panel-container").offset().top),alert("Congratulations!\nYour score is "+t+"!\nThanks for playing!");var e=["images/mushroom.png","images/pig-mushroom-cap.png","images/pig.png"],s=["images/mushroom-poison.png","images/wildboar-mushroom-cap.png","images/wildboar.png"],o=function(i,a){var e=$(i).find("img").attr("src"),t=_.indexOf(a,e);t=(t+1)%a.length,$(i).find("img").attr("src",a[t])};$(".end-mushroom").click(function(){o(this,e)}),$(".end-mushroom-poison").click(function(){o(this,s)}),$(".small").click(function(){$(this).toggleClass("rubberBand")}),$(".icon-repeat").click(function(){XMing.GameStateManager.startGame()})},this.isGameStateInitial=function(){return i==n.INITIAL},this.isGameStateStart=function(){return i==n.START},this.isGameStateEnd=function(){return i==n.END}};