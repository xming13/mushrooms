var XMing=XMing||{};XMing.GameStateManager=new function(){var i,e,a,t,s=0,n={},o={INITIAL:"initial",START:"start",PAUSE:"pause",END:"end"},c={SINGLE:"single",DOUBLE:"double",POISON:"poison"};this.init=function(){window.addEventListener("resize",this.onResize.bind(this),!1),this.initGame()},this.loadData=function(){var i=this,o="<li><div class='shroom-holder'><div class='image-holder'><img class='new-shroom' src='images/transparent.png' /></div></div></li>",r=[];_.times(16,function(){r.push(o)}),$(".game-grid").html(""),_.each(r,function(i){$(".game-grid").append(i)}),this.onResize(),$("html, body").scrollTop($("#panel-container").offset().top),function m(){t-=1,$("#timer-value").html(t),0>=t?i.endGame():e=setTimeout(m,1e3)}(),function d(){var e=_.random(2,5);_.each(_.sample($(".image-holder"),e),function(i){if(!$(i).data("type")){var e=_.sample(c);$(i).data("type",e),$(i).find("img").attr("src",n[e])}}),_.each($(".image-holder"),function(i){var e=$(i);if(e.data("type")&&!e.data("hasStarted")&&!e.data("hasStopped")){var a=e.parent().parent("li").height();e.css("top",a+"px").data("hasStarted",!0).animate({top:"0px"},{duration:500,complete:function(){var i=$(this);setTimeout(function(){i.data("hasStopped")||i.animate({top:a+"px"},{duration:500,complete:function(){i.css("top",a+"px").data("type","").data("isClicked","").data("hasStarted","")}})},1e3)}})}}),i.isGameStateEnd()||(a=setTimeout(d,2e3))}(),$(".image-holder").click(function(){var i=$(this);if(i.data("type")&&!i.data("hasStopped")){var e,a=i.data("type"),t=i.find("img"),o=!1;switch(a){case c.SINGLE:t.attr("src",n[a+"-clicked"]),s++,e=$("<div class='score-popup animated bounceIn'>+1</div>");break;case c.DOUBLE:i.data("isClicked")?(t.attr("src",n[a+"-clicked-twice"]),s+=2,e=$("<div class='score-popup animated bounceIn'>+2</div>")):(i.data("isClicked",!0),t.attr("src",n[a+"-clicked-once"]),o=!0);break;case c.POISON:t.attr("src",n[a+"-clicked"]),s--,e=$("<div class='score-popup penalty animated bounceIn'>-1</div>")}if(!o){$("#score-value").html(s),i.data("hasStopped",!0).stop();var r=i.parent().parent("li"),m=$("<img src='images/mushroom-small.png' class='popup' />");e.prepend(m),r.prepend(e),e.css("top",this.offsetTop-m.height()+"px"),$(".score-popup").one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){e.remove()}),setTimeout(function(){e.remove(),i.css("top",r.height()+"px").data("type","").data("isClicked","").data("hasStarted","").data("hasStopped","")},500)}}})},this.onResize=function(){var i=$(".game-grid").children("li"),e=_.max(i,function(i){return $(i).width()}),a=$(e).width();_.each(i,function(i){$(i).height(a),$(i).find(".content:not(.last)").css("line-height",a+"px")})},this.preloadImage=function(){var i=new Image;i.src="images/mushroom.png",n[c.SINGLE]=i.src;var e=new Image;e.src="images/mushroom-clicked.png",n[c.SINGLE+"-clicked"]=e.src;var a=new Image;a.src="images/mushroom-double.png",n[c.DOUBLE]=a.src;var t=new Image;t.src="images/mushroom-double-clicked-once.png",n[c.DOUBLE+"-clicked-once"]=t.src;var s=new Image;s.src="images/mushroom-double-clicked-twice.png",n[c.DOUBLE+"-clicked-twice"]=s.src;var o=new Image;o.src="images/mushroom-poison.png",n[c.POISON]=o.src;var r=new Image;r.src="images/mushroom-poison-clicked.png",n[c.POISON+"-clicked"]=r.src;var m=new Image;m.src="images/pig.png";var d=new Image;d.src="images/pig-mushroom-cap.png";var l=new Image;l.src="images/wildboar.png";var p=new Image;p.src="images/wildboar-mushroom-cap.png"},this.initGame=function(){i=o.INITIAL;var e=this;this.preloadImage(),$(".icon-repeat").click(function(){e.startGame()})},this.startGame=function(){i=o.START,s=0,$("#score-value").html(s),t=61,$("#timer-value").html(t),$("#timer").show(),$("#replay").hide(),this.loadData()},this.endGame=function(){i=o.END,clearTimeout(e),clearTimeout(a);var t="<li><div class='content end-mushroom'><img src='images/mushroom.png' class='animated tada' /></div></li>";t+="<li><div class='content'><img src='images/mushroom-clicked.png' /></div></li>",t+="<li><div class='content end-mushroom-poison'><img src='images/mushroom-poison.png' class='animated tada' /></div></li>",t+="<li><div class='content'><img src='images/mushroom-poison-clicked.png' /></div></li>",t+="<li><div class='content'>G</div></li>",t+="<li><div class='content'>A</div></li>",t+="<li><div class='content'>M</div></li>",t+="<li><div class='content'>E</div></li>",t+="<li><div class='content'>O</div></li>",t+="<li><div class='content'>V</div></li>",t+="<li><div class='content'>E</div></li>",t+="<li><div class='content'>R</div></li>",t+="<li><div class='content'><img src='images/mushroom-double.png' /></div></li>",t+="<li><div class='content'><img src='images/mushroom-double-clicked-once.png' /></div></li>",t+="<li><div class='content'><img src='images/mushroom-double-clicked-twice.png' /></div></li>",t+="<li><div class='content last'><img src='images/mushroom-small.png' class='small animated' /></div></li>",$(".game-grid").html(t),$("#timer").hide(),$("#replay").show(),$("#score-value").html(s),this.onResize(),$("html, body").scrollTop($("#panel-container").offset().top),alert("Congratulations!\nYour score is "+s+"!\nThanks for playing!");var n=["images/mushroom.png","images/pig-mushroom-cap.png","images/pig.png"],c=["images/mushroom-poison.png","images/wildboar-mushroom-cap.png","images/wildboar.png"],r=function(i,e){var a=$(i).find("img").attr("src"),t=_.indexOf(e,a);t=(t+1)%e.length,$(i).find("img").attr("src",e[t])};$(".end-mushroom").click(function(){r(this,n)}),$(".end-mushroom-poison").click(function(){r(this,c)}),$(".small").click(function(){$(this).toggleClass("rubberBand")})},this.isGameStateInitial=function(){return i==o.INITIAL},this.isGameStateStart=function(){return i==o.START},this.isGameStateEnd=function(){return i==o.END}};