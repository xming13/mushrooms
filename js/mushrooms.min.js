var XMing=XMing||{};XMing.GameStateManager=new function(){var e;var t=0;var n;var r;var i;var s={};var o={INITIAL:"initial",START:"start",PAUSE:"pause",END:"end"};var u={SINGLE:"single",DOUBLE:"double",POISON:"poison"};this.init=function(){window.addEventListener("resize",this.onResize.bind(this),false);this.initGame()};this.loadData=function(){var e=this;var o="<li>"+"<div class='shroom-holder'>"+"<div class='image-holder'>"+"<img class='new-shroom' src='images/transparent.png' />"+"</div>"+"</div>"+"</li>";$(".game-grid").html("");_.times(16,function(){$(".game-grid").append(o)});this.onResize();$("html, body").scrollTop($("#panel-container").offset().top);(function a(){i-=1;$("#timer-value").html(i);if(i<=0){e.endGame()}else{n=setTimeout(a,1e3)}})();(function f(){var t=_.random(2,5);_.each(_.sample($(".image-holder"),t),function(e){if(!$(e).data("type")){var t=_.sample(u);$(e).data("type",t);$(e).find("img").attr("src",s[t])}});_.each($(".image-holder"),function(e){var t=$(e);if(t.data("type")&&!t.data("hasStarted")&&!t.data("hasStopped")){var n=t.parent().parent("li").height();t.css("top",n+"px").data("hasStarted",true).animate({top:"0px"},{duration:500,complete:function(){var e=$(this);setTimeout(function(){if(!e.data("hasStopped")){e.animate({top:n+"px"},{duration:500,complete:function(){e.css("top",n+"px").data("type","").data("isClicked","").data("hasStarted","")}})}},1e3)}})}});if(!e.isGameStateEnd()){r=setTimeout(f,2e3)}})();$(".image-holder").click(function(){var e=$(this);if(e.data("type")&&!e.data("hasStopped")){var n=e.data("type");var r=e.find("img");var i;var o=false;switch(n){case u.SINGLE:r.attr("src",s[n+"-clicked"]);t++;i=$("<div class='score-popup animated bounceIn'>+1</div>");break;case u.DOUBLE:if(e.data("isClicked")){r.attr("src",s[n+"-clicked-twice"]);t+=2;i=$("<div class='score-popup animated bounceIn'>+2</div>")}else{e.data("isClicked",true);r.attr("src",s[n+"-clicked-once"]);o=true}break;case u.POISON:r.attr("src",s[n+"-clicked"]);t--;i=$("<div class='score-popup penalty animated bounceIn'>-1</div>");break}if(!o){$("#score-value").html(t);e.data("hasStopped",true).stop();var a=e.parent().parent("li");var f=$("<img src='images/mushroom-small.png' class='popup' />");i.prepend(f);a.prepend(i);i.css("top",this.offsetTop-f.height()+"px");$(".score-popup").one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){i.remove()});setTimeout(function(){i.remove();e.css("top",a.height()+"px").data("type","").data("isClicked","").data("hasStarted","").data("hasStopped","")},500)}}})};this.onResize=function(e){var t=$(".game-grid").children("li");var n=_.max(t,function(e){return $(e).width()});var r=$(n).width();_.each(t,function(e){$(e).height(r);$(e).find(".content:not(.last)").css("line-height",r+"px")})};this.preloadImage=function(){var e=new Image;e.src="images/mushroom.png";s[u.SINGLE]=e.src;var t=new Image;t.src="images/mushroom-clicked.png";s[u.SINGLE+"-clicked"]=t.src;var n=new Image;n.src="images/mushroom-double.png";s[u.DOUBLE]=n.src;var r=new Image;r.src="images/mushroom-double-clicked-once.png";s[u.DOUBLE+"-clicked-once"]=r.src;var i=new Image;i.src="images/mushroom-double-clicked-twice.png";s[u.DOUBLE+"-clicked-twice"]=i.src;var o=new Image;o.src="images/mushroom-poison.png";s[u.POISON]=o.src;var a=new Image;a.src="images/mushroom-poison-clicked.png";s[u.POISON+"-clicked"]=a.src;var f=new Image;f.src="images/pig.png";var l=new Image;l.src="images/pig-mushroom-cap.png";var c=new Image;c.src="images/wildboar.png";var h=new Image;h.src="images/wildboar-mushroom-cap.png"};this.initGame=function(){e=o.INITIAL;var t=this;this.preloadImage();$(".icon-repeat").click(function(){t.startGame()})};this.startGame=function(){e=o.START;t=0;$("#score-value").html(t);i=61;$("#timer-value").html(i);$("#timer").show();$("#replay").hide();this.loadData()};this.endGame=function(){e=o.END;clearTimeout(n);clearTimeout(r);var i="<li><div class='content end-mushroom'><img src='images/mushroom.png' class='animated tada' /></div></li>";i+="<li><div class='content'><img src='images/mushroom-clicked.png' /></div></li>";i+="<li><div class='content end-mushroom-poison'><img src='images/mushroom-poison.png' class='animated tada' /></div></li>";i+="<li><div class='content'><img src='images/mushroom-poison-clicked.png' /></div></li>";i+="<li><div class='content'>G</div></li>";i+="<li><div class='content'>A</div></li>";i+="<li><div class='content'>M</div></li>";i+="<li><div class='content'>E</div></li>";i+="<li><div class='content'>O</div></li>";i+="<li><div class='content'>V</div></li>";i+="<li><div class='content'>E</div></li>";i+="<li><div class='content'>R</div></li>";i+="<li><div class='content'><img src='images/mushroom-double.png' /></div></li>";i+="<li><div class='content'><img src='images/mushroom-double-clicked-once.png' /></div></li>";i+="<li><div class='content'><img src='images/mushroom-double-clicked-twice.png' /></div></li>";i+="<li><div class='content last'><img src='images/mushroom-small.png' class='small animated' /></div></li>";$(".game-grid").html(i);$("#timer").hide();$("#replay").show();$("#score-value").html(t);this.onResize();$("html, body").scrollTop($("#panel-container").offset().top);swal({title:"Congratulations!",text:"You have collected "+t+" mushrooms! :D",imageUrl:"images/mushroom-small.png"});var s=["images/mushroom.png","images/pig-mushroom-cap.png","images/pig.png"];var u=["images/mushroom-poison.png","images/wildboar-mushroom-cap.png","images/wildboar.png"];var a=function(e,t){var n=$(e).find("img").attr("src");var r=_.indexOf(t,n);r=(r+1)%t.length;$(e).find("img").attr("src",t[r])};$(".end-mushroom").click(function(){a(this,s)});$(".end-mushroom-poison").click(function(){a(this,u)});$(".small").click(function(){$(this).toggleClass("rubberBand")})};this.isGameStateInitial=function(){return e==o.INITIAL};this.isGameStateStart=function(){return e==o.START};this.isGameStateEnd=function(){return e==o.END}}